# Cursor Rules for Virtual Fitting Room Project

## Project Architecture
- **Hybrid Architecture**: "Front Store, Back Factory" (前店後廠).
- **Primary Environment (Windows)**: RTX 4090 / CUDA. Core environment for AI generation (3D Body & Objects). 100x faster than Mac MPS.
- **Auxiliary Environment (Mac)**: M4 / MPS. Used for mobile development, UI/UX demo, and remote coding.
- **Backend**: FastAPI (Python 3.11).
- **Frontend**: React + Three.js.

## Development Guidelines
- Always prioritize **relative paths** using `Path(__file__)` or `os.path`.
- Backend outputs should be saved in `backend/outputs/` and served via `/outputs` mount.
- Frontend configuration is located in `frontend/src/config/index.ts`.
- AI logic is encapsulated in `backend/body_service.py` (Singleton pattern).
- Factory logic is located in `clothing-factory/sam-3d-objects/`.

## Hardware Optimization
- **Mac**: Use **MPS** (Metal Performance Shaders) for torch.
- **Windows**: Use **CUDA** (NVIDIA RTX 4090).
- Use `device = "cuda" if torch.cuda.is_available() else "mps" if torch.backends.mps.is_available() else "cpu"`.

## Cross-Platform Compatibility
- Always use `pathlib.Path` or `os.path.join` for file paths to support both `\` (Windows) and `/` (Mac).
- Python 3.11 is the standard across all platforms.
- For Windows, assume environments managed by **Conda**.
- For Mac, assume environments managed by **venv**.

## Windows Development (Clothing Factory)
- When working in `clothing-factory/`, assume **PowerShell** or **WSL2**.
- Focus on **CUDA** compatibility and **PyTorch3D** specific issues.
- Outputs should target `frontend/public/models/` for easy sharing.

## File Naming Conventions
- Generated bodies: `{image_name}_body_{index}.obj`
- Generated clothes: `{image_name}_cloth_{index}.obj`

## Technical Insights (SAM 3D Body & Objects)
- **Model Alignment**: Official logic for aligning body and clothing models in the same frame of reference exists in `clothing-factory/sam-3d-objects/notebook/demo_3db_mesh_alignment.ipynb`. This is critical for future "Virtual Fitting" features.
- **Promptable Inference**: Both models support auxiliary prompts (2D keypoints, masks) to guide 3D reconstruction for complex scenes.
- **MHR Representation**: Human models use **Momentum Human Rig (MHR)**, which decouples skeletal structure from surface shape, facilitating easier posing and clothing fit.
- **Detectors**: The system supports multiple detectors (e.g., **ViTdet**, **sam3**). ViTdet is the high-quality default.
- **Internal Representations**: SAM 3D Objects can produce both **Gaussian Splatting** (exportable as `.ply`) and **Meshes** (exportable as `.glb`/`.obj`).
- **Scene Handling**: Robustly handles multi-object reconstruction, occlusions, and clutter. Details found in `demo_single_object.ipynb` and `demo_multi_object.ipynb`.

## Documentation & Maintenance
- **Keep Logs Updated**: After every significant milestone or environment change, update `PROJECT_DEVELOPMENT_LOG.md`.
- **Sync Troubleshooting**: Add new errors and solutions to `SETUP_TROUBLESHOOTING.md` immediately after resolving them.
- **Maintain README**: Ensure `README.md` reflects the current setup steps and architecture.
- **Chinese Response**: Always respond in Traditional Chinese (繁體中文).
